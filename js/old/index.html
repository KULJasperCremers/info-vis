<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>

    
    <div id="maximized_screen" class="container mt-3" >
        <div class="row">
            <div class="col chart">
                <h1 class="text-center">Something</h1>

                <p style="padding-left: 20px;">Visualise:</p>
                <div class="dropdown" id="dropdownBigMap" style="padding-left: 10px;">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownBigMap" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dropdown button
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonBigMap">
                        
                    </div>
                </div>
                

                <label for="mapRangeSlider" class="form-label">Range</label>
                <input type="range" class="form-range" id="mapRangeSlider" min="0" max="8">
            </div>

            
        </div>
        <div class="row">
            <div class="col">
                <div id="map_big" class="chart"></div>
            </div>
        </div>
    </div>
    
    <div id="map_small"></div>

    
    <div id="minimized_screen" class="container mt-3">
        <h1 id="country" class="text-center">Country Name</h1>

        <div class="row">
            <div class="col chart" style="display: flex">
                <h3 style="padding-right: 10px; margin: 10px;">Election year:</h1>

                
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" onclick="changeMultiYear(this)">
                    <label class="form-check-label" for="flexSwitchCheckChecked">Multiple years</label>
                </div>
                <p style="padding-left: 100px;">From:</p>
                <div class="dropdown" id="yearsDropdown2" style="padding-left: 10px;">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dropdown button
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    </div>
                </div>
                <p style="padding-left: 20px;"> - To:</p>
                <div class="dropdown" id="yearsDropdown"  style="padding-left: 10px;">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Dropdown button
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    </div>
                </div>

                
            </div>
        </div>
    
        <div style="display: flex; align-items: center;">
            <!-- First Row -->
            <div class="row">
                <!-- Content for Row 1, Column 1 -->
                <div id="row1col1"  class="col chart">
                </div>
                <div id="row2col1" class="col chart">
                </div>
            </div>
        
            <!-- Second Row -->
            <div class="row">
                <div id="row1col2"  class="col chart">
                </div>
                <div id="row2col2" class="col chart">
                </div>
            </div>
    </div>

</body>

<script src="datahelper.js"></script>
<script src="maps/leaning_growth_map.js"></script>
<script src="maximized/satisfaction_trend.js"></script>
<script src="maximized/happy_trend.js"></script>
<script src="maximized/trust_trend.js"></script>
<script src="maximized/leaning_trend.js"></script>
<script src="minimized/circles.js"></script>
<script src="minimized/happiness.js"></script>
<script src="minimized/mostpopularleaning.js"></script>
<script src="minimized/satisfaction.js"></script>
<script src="map.js"></script>
<script>

    let cdata;
    let aggregatedsurveyData;
    let years;
    let countries;
    d3.json("../json/ess_data_all.json").then(function(d) {
        cdata = d;
        countries = Object.keys(cdata);
        years = mapYears(cdata,countries);
        aggregatedsurveyData = aggregateSurveyData(cdata,years);

        visualiseCategoriesParams['cdata'] = cdata;
    });

    var minimized = false;
    var selectedCountry = undefined; 

    var selectedElectionYear_To = undefined;
    var selectedElectionYearIndex_To = 0;

    var selectedElectionYear_From = undefined;
    var selectedElectionYearIndex_From = 0;

    var selectedElectionYear_SliderValue = 0;


    var cellSize = 400;

    const visualiseCategories = {
        "Satisfaction": countrySatisfactionColorFunc,
        "Trust Country": countryTrustColorFunc,
        "Trust EU": countryTrustEUColorFunc,
        "Happiness": countryHappyColorFunc,
        "Leaning": countryLeaningGrowthColorFunc,
    }

    const visualiseCategoriesParams = {}

    var selectedVisualiseCategory = "Satisfaction";


    function countrySatisfactionColorFunc(country, params) {
        let dis = getHighestCountryDistribution(country, "satisfaction", selectedElectionYear_SliderValue);
        if (dis === -1) {
            return "rgba(211, 211, 211, 1)";
        }
        return interpolateRedGreen(dis);
    }

    function countryTrustColorFunc(country, params) {
        let dis = getHighestCountryDistribution(country, "trust_country", selectedElectionYear_SliderValue);
        if (dis === -1) {
            return "rgba(211, 211, 211, 1)";
        }
        return interpolateRedGreen(dis);
    }

    function countryTrustEUColorFunc(country, params) {
        let dis = getHighestCountryDistribution(country, "trust_eu", selectedElectionYear_SliderValue);
        if (dis === -1) {
            return "rgba(211, 211, 211, 1)";
        }
        return interpolateRedGreen(dis);
    }

    function countryHappyColorFunc(country, params) {
        let dis = getHighestCountryDistribution(country, "happy", selectedElectionYear_SliderValue);
        if (dis === -1) {
            return "rgba(211, 211, 211, 1)";
        }
        return interpolateRedGreen(dis);
    }

    document.getElementById('mapRangeSlider').addEventListener('input', function() {
        selectedElectionYear_SliderValue = this.value;
        DrawMap();
    });

    DrawMap();

    $('#dropdownMenuButton2').hide();

    d3.select("#dropdownBigMap .dropdown-menu").selectAll('*').remove();

    Object.keys(visualiseCategories).forEach(function(key) {
        // Append a new dropdown item for each key
        $('#dropdownBigMap .dropdown-menu').append(
            `<a class="dropdown-item" href="#">${key}</a>`
        );
    });

 
    $('#dropdownBigMap button').text(selectedVisualiseCategory);

    $('#dropdownBigMap .dropdown-item').click(function() {
        selectedVisualiseCategory = $(this).text();
        DrawMap();
    });


    function changeMultiYear(toggle) {
        if (!toggle.checked) {
            selectedElectionYear_From = undefined;
            $('#dropdownMenuButton2').hide();
        }
        else {
            var years = getElectionYears(cdata, countryCodes[selectedCountry]);
            selectedElectionYear_From = years[years.length - 2];
            selectedElectionYearIndex_From = years.length - years.indexOf(selectedElectionYear_To) - 1;
            $('#dropdownMenuButton2').text(selectedElectionYear_From);
            $('#dropdownMenuButton2').show();
        }
        OnReloadMinimized();
    }

    function OnHoverCountry(countryCode) {
    }

    function OnClickCountry(countryCode) {
        console.log("click: " + countryCode);
        
        selectedCountry = countryCode;

        document.getElementById("country").innerText=countryCode;
        if (!minimized) {
            SwitchMap();
        }
        else {
            OnMinimized();
        }
    }

    function SwitchMap() {
        minimized = !minimized;
        DrawMap();
    }

    function countryColorFunc(country) {
        return visualiseCategories[selectedVisualiseCategory](country, visualiseCategoriesParams)
    }

    function interpolateRedGreen(t) {
        if (t < 0 || t > 1) {
            return 'Value must be between 0 and 1';
        }

        // Calculate red and green components
        const red = 255 * (1 - t);
        const green = 255 * t;

        // Convert each component to an integer
        const r = Math.round(red);
        const g = Math.round(green);

        // Return the color in hexadecimal format
        return `rgb(${r}, ${g}, 0)`;
    }

    function DrawMap() {
        d3.select('#map_big').selectAll('*').remove();
        d3.select('#map_small').selectAll('*').remove();

        if (!minimized) {

            var w = window.innerWidth * 0.8;
            var h = w / 2;

            var svg = AppendMap('#map_big', OnHoverCountry, OnClickCountry, countryColorFunc, w, h);
            d3.select('#map_big').classed('minimized', false);
            d3.select('#map_big').classed('maximized', true);

            document.getElementById('minimized_screen').classList.add('hidden');
            document.getElementById('maximized_screen').classList.remove('hidden');

            OnMaximized();

        } else {
            var svg = AppendMap('#map_small', OnHoverCountry, OnClickCountry, undefined, 280, 200);
            d3.select('#map_small').classed('minimized', true);
            d3.select('#map_small').classed('maximized', false);

            svg.append("image")
                .attr("xlink:href", "https://cdn.icon-icons.com/icons2/390/PNG/512/expand_38551.png") // Ensure the use of xlink:href for compatibility
                .attr("x", 10)
                .attr("y", 10)
                .attr("width", 30)
                .attr("height", 30)
                .on("click", function() {
                    SwitchMap();
                });

            document.getElementById('minimized_screen').classList.remove('hidden');
            document.getElementById('maximized_screen').classList.add('hidden');

            
            OnMinimized();
        }

    }

    window.addEventListener('resize', function(event) {
        DrawMap();
    }, true);
  
    function OnMinimized() {

        // Fill dropdown
        var years = getElectionYears(cdata, countryCodes[selectedCountry]);
        selectedElectionYear_To = years[years.length - 1];
        selectedElectionYearIndex_To = years.length - years.indexOf(selectedElectionYear_To) - 1;

        OnReloadMinimized();
    }

    function OnReloadMinimized() {

        // Fill dropdown
        var years = getElectionYears(cdata, countryCodes[selectedCountry]);

        selectedElectionYearIndex_To = years.length - years.indexOf(selectedElectionYear_To) - 1;

        if (selectedElectionYearIndex_From !== undefined) {
            selectedElectionYearIndex_From = years.length - years.indexOf(selectedElectionYear_From) - 1;
        }

        //#region DROPDOWN
        d3.select("#yearsDropdown .dropdown-menu").selectAll('*').remove();

        $(years).each(function(index, year) {
            $('#yearsDropdown .dropdown-menu').append(
                `<a class="dropdown-item" href="#">${year}</a>`
            );
        });
        $('#dropdownMenuButton').text(selectedElectionYear_To);

        $('#yearsDropdown .dropdown-item').click(function() {
            selectedElectionYear_To = $(this).text();
            OnReloadMinimized(); // Change button text to the clicked item
        });

        
        d3.select("#yearsDropdown2 .dropdown-menu").selectAll('*').remove();

        $(years).each(function(index, year) {
            $('#yearsDropdown2 .dropdown-menu').append(
                `<a class="dropdown-item" href="#">${year}</a>`
            );
        });
        $('#dropdownMenuButton2').text(selectedElectionYear_From);

        $('#yearsDropdown2 .dropdown-item').click(function() {
            selectedElectionYear_From = $(this).text();
            OnReloadMinimized(); // Change button text to the clicked item
        });
        //#endregion

        if (selectedElectionYear_From === undefined) {
            OnMinimizedOneElectionSelected();
        }
        else {
            OnMinimizedTwoElectionSelected();
        }
    }

    function OnMinimizedOneElectionSelected() {
        clearMinimizedCharts();

        circles(cdata, "#row1col1");
        happiness(cdata, "#row1col2");
        satisfaction(cdata, "#row2col1");
        mostpopularleaning(cdata, "#row2col2");
        
    }

    function OnMinimizedTwoElectionSelected() {
        clearMinimizedCharts();

        satisfaction_trend(cdata, "#row1col1");
        leaning_trend(cdata, "#row1col2");
        happy_trend(cdata, "#row2col1");
        trust_trend(cdata, "#row2col2");
        //leaning_trend(cdata);
    }

    function OnMaximized() {

    }

    function clearMinimizedCharts() {
        const div1 = d3.select("#row1col1");
                div1.selectAll("svg").remove();        

        const div2 = d3.select("#row1col2");
                div2.selectAll("svg").remove();       

        const div3 = d3.select("#row2col1");
                div3.selectAll("svg").remove();     

        const div4 = d3.select("#row2col2");
                div4.selectAll("svg").remove();
    }

</script>

</html>
