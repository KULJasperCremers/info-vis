<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <link href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>

    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
        <div class="row">
            <div class="col" style="margin-right: -37;">
                <div class="row chart"><h1  class="text-center" id="countryHeader">Country</h1></div>
                <div id="graph"></div>
            </div>
            
            <div class="col-1" style="margin-right: 0;" id="radio-leanings">
                <div  class="chart2" style="margin-top: 150%;">
                    <p class="text-center"><strong>Map</strong></p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-map" id="radio-largest-growth" onclick="selectMapMode(this, 'largest-growth')" checked>
                        <label class="form-check-label" for="radio-largest-growth">
                            <strong>Max Growth</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-map" id="radio-largest-decline" onclick="selectMapMode(this, 'largest-decline')">
                        <label class="form-check-label" for="radio-largest-decline">
                            <strong>Max Decline</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-map" id="radio-cumulative-growth" onclick="selectMapMode(this, 'cumulative-growth')">
                        <label class="form-check-label" for="radio-cumulative-growth">
                            <strong>Total Growth</strong>
                        </label>
                    </div>
                </div>
                <div  class="chart2" style="margin-top: 10%;">
                    <p class="text-center"><strong>Leanings</strong></p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-far-left" style="background-color:#e31a1c ;" onclick="selectLeaning(this, 'Far Left')">
                        <label class="form-check-label" for="radio-far-left">
                        <strong>Far-Left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-left" style="background-color: #fb9a99;" onclick="selectLeaning(this, 'Left')">
                        <label class="form-check-label" for="radio-left">
                            <strong>Left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-center-left" style="background-color: #b2df8a;" onclick="selectLeaning(this, 'Center Left')">
                        <label class="form-check-label" for="radio-center-left">
                            <strong>Center-Left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-center" style="background-color: #33a02c;" onclick="selectLeaning(this, 'Center')">
                        <label class="form-check-label" for="radio-center">
                            <strong>Center</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-center-right" style="background-color:#a6cee3;" onclick="selectLeaning(this, 'Center Right')">
                        <label class="form-check-label" for="radio-center-right">                                                              
                            <strong>Center-Right</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-right" style="background-color:#1f78b4;" onclick="selectLeaning(this, 'Right')">
                        <label class="form-check-label" for="radio-right">
                            <strong>Right</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="flexRadioDefault" id="radio-far-right" checked style="background-color:#fdbf6f;" onclick="selectLeaning(this, 'Far Right')">
                        <label class="form-check-label" for="radio-far-right">
                            <strong>Far-Right</strong>
                        </label>
                    </div>
                </div>
                <div class="chart2" style="margin-top: 10%;">
                    <p class="text-center"><strong>Survey</strong></p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-survey" id="radio-happy" style="background-color:#FFCC0D;" onclick="selectSurvey(this, 'happy')" checked>
                        <label class="form-check-label" for="radio-happy">
                        <strong>Happiness</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-survey" id="radio-satisfaction" style="background-color:#00796B;" onclick="selectSurvey(this, 'satisfaction')">
                        <label class="form-check-label" for="radio-satisfaction">
                            <strong>Satisfaction</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-survey" id="radio-trust-country" style="background-color:#BF2669;" onclick="selectSurvey(this, 'trust_country')">
                        <label class="form-check-label" for="radio-trust-country">
                            <strong>Trust Country</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="radio-survey" id="radio-trust-eu" style="background-color:#637d92;" onclick="selectSurvey(this, 'trust_eu')">
                        <label class="form-check-label" for="radio-trust-eu">
                            <strong>Trust EU</strong>
                        </label>
                    </div>
                </div>

            </div>
            <div class="col">
            <div class="row chart" style="margin-bottom: 2%">
                <h1 class="text-center">Date Selection</h1>
                <div class="row">
                    <div style="margin-bottom: 3rem; margin-left: 1rem; margin-right: 1rem;">
                        <div id="slider"></div>
                    </div>
                </div>
            </div>
            <div class="row chart">
                    <div id="map"></div>
            </div>
            </div>
        </div>

<script src="datahelper.js"></script>
<script src="graphs.js"></script>
<script src="slider.js"></script>
<script>

    let data;
    let all_dates = [];

    let surveyData;
    let allSurveyDates = [];
    
    let map;
    let geodata;
    let geojsonLayer ;
    
    var cellSize = 400;
    var selectedCountry = undefined; 
    var selectedLeaning = "Far Right"

    var selectedFromDate = undefined;
    var selectedToDate = undefined;

    var selectedSurveyType = "happy";
    var selectedMapMode = "largest-growth";
    var selectedCountryColorFunc = countryColorFuncLargestGrowth;

    var selectedLeanings = [];

    var radios = document.querySelectorAll('#radio-happy, #radio-satisfaction, #radio-trust-country, #radio-trust-eu');
    var previousSelection;

    var leaning_colors = {
        "far-left": "#e31a1c",
        "left": "#fb9a99",
        "center-left": "#b2df8a",
        "center": "#33a02c",
        "center-right": "#a6cee3",
        "right": "#1f78b4",
        "far-right": "#fdbf6f"
    }

    let countryColors = {}
    let countryLargest = {} 
    let countryPercentages = {}

    var graphSvg

    /*d3.json("../json/ess_data_all.json").then(function(d) {
        aggregateSurveyMeansForAllCountries(d);
        aggregateElectionDataForAllCountries(d);
    })*/
    Promise.all([
        d3.json("../json/surveyMeans.json"),
        d3.json("../json/electionData.json"),
        d3.json("../json/geojson.json")
    ]).then(function(files) {
        surveyData = files[0];
        data = files[1];
        geodata = files[2];

        Object.values(newCountryCodes).forEach(element => {
            var surveyDates = get_all_dates(surveyData, element);
            var dates = get_all_dates(data, element);
            allSurveyDates.push(...surveyDates);
            all_dates.push(...dates); 
        });

        allSurveyDates = [...new Set(allSurveyDates)];
        allSurveyDates.sort((a, b) => a - b);
        all_dates = [...new Set(all_dates)];
        all_dates.sort((a, b) => a - b);

        selectCountry("Belgium");

        document.getElementById("radio-far-left").checked = false;
        document.getElementById("radio-left").checked = false;
        document.getElementById("radio-center-left").checked = false;
        document.getElementById("radio-center").checked = false;
        document.getElementById("radio-center-right").checked = false;
        document.getElementById("radio-right").checked = false;
        document.getElementById("radio-far-right").checked = true;

        document.getElementById("radio-cumulative-growth").checked = false;
        document.getElementById("radio-largest-decline").checked = false;
        document.getElementById("radio-largest-growth").checked = true;

        selectLeaning(
            document.getElementById("radio-far-right"),
            'Far Right'
        )


        previousSelection = document.getElementById("radio-happy");
        previousSelection.checked = true

        map = L.map('map', { 
            zoomControl: false,
            scrollWheelZoom: false,
            dragging: false,
            touchZoom: false,
            doubleClickZoom: false,
            boxZoom: false
        }).setView([56, 10], 4);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        geojsonLayer = L.geoJSON(geodata, {
            onEachFeature: function(feature, layer) {

                if (feature.properties && feature.properties.name) {
                        layer.bindTooltip(feature.properties.name, {
                        permanent: true,
                        className: 'no-background',
                        direction: 'center',
                        offset: [0, 0] 
                    });
                }

            layer.on('click', function() {
                OnClickCountry(feature.properties.name);
            });
            layer.on('mouseover', function() {

                if (countryPercentages[feature.properties.name] === "") {
                    layer.bindTooltip("No growth for this country!", {
                        permanent: false,
                        direction: 'center',
                        offset: [0, 0]
                    }).openTooltip();
                }

                if (document.getElementById("radio-cumulative-growth").checked) {
                    return;
                }

                if (countryPercentages[feature.properties.name] !== "") {
                    d3.selectAll(".line").style("opacity", 0.1);
                    d3.selectAll("." + countryLargest[feature.properties.name].replace(/\s+/g, '-')).style("opacity", 1);  // Highlight the hovered line
                    var checkboxes = document.querySelectorAll('#radio-leanings .form-check-input[type="checkbox"]');
                    checkboxes.forEach(element => {
                        if (element.id !== "radio-" + countryLargest[feature.properties.name]) {
                            element.disabled = true;
                        }
                    });

                    var values = filteredDataByLeaning.find(([key, values]) => key === countryLargest[feature.properties.name])[1];

                    values.forEach(function(d) {
                        var position = xPositions[d.year];
                        if (position) {
                            graphSvg.append("text")
                            .attr("x", position.x) 
                            .attr("y", position.y) 
                            .attr("class", "x-value")
                            .text(d.growth.toFixed(1));
                        }
                    });

                    // bar chart switch!!
                    displayGraphs(true, countryLargest[feature.properties.name])
                    radios.forEach((radio) => {
                        if (radio.checked) {
                            previousSelection = radio;
                            radio.checked = false;
                        }
                    });
                }
            });
            layer.on('mouseout', function() {
                if (layer.getTooltip() && !layer.getTooltip().options.permanent) {
                    layer.unbindTooltip();
                }
                d3.selectAll(".line").style("opacity", 1);

                d3.selectAll(".x-value").remove();

                var checkboxes = document.querySelectorAll('#radio-leanings .form-check-input[type="checkbox"]');
                checkboxes.forEach(element => {
                        element.disabled = false;
                });
                // bar chart switch!!
                displayGraphs()
                if (previousSelection) {
                    previousSelection.checked = true;
                }
            });
        }}).addTo(map);

        colorMap();
        colorBorder();

    });

    var countryCodes = {
        "Austria": "AT",
        "Belgium": "BE",
        "Germany": "DE",
        "Denmark": "DK",
        "Greece": "EL",
        "Spain": "ES",
        "Finland": "FI",
        "France": "FR",
        "Ireland": "IE",
        "Italy": "IT",
        "Netherlands": "NL",
        "Portugal": "PT",
        "Sweden": "SE",
    }

    function colorMap(leaning = undefined) {
        if (geojsonLayer) {

            for (let key in countryCodes) {
                var outp = selectedCountryColorFunc(key);
                countryPercentages[key] = outp[0];
                countryColors[key] = outp[1];
                countryLargest[key] = outp[2];
            }

            geojsonLayer.setStyle(function(feature) {
                if (leaning === undefined) {
                    return { 
                        color: countryColors[feature.properties.name]
                    };
                }
                else {
                    return { 
                        color: countryLargest[feature.properties.name] === leaning ? countryColors[feature.properties.name] : "white"
                    };
                }
            });

            geojsonLayer.eachLayer(function(layer) {
                if (layer.feature && layer.feature.properties && layer.feature.properties.name) {
                    var newName = countryPercentages[layer.feature.properties.name];
                    if (newName > 0) {
                        layer.unbindTooltip();
                        layer.bindTooltip(newName !== "" ? "+" + newName + "%" : " ", {
                            permanent: true,
                            className: 'no-background',
                            direction: 'center',
                            offset: [0, 0] 
                        });
                    } else if (newName < 0) {
                        layer.unbindTooltip();
                        layer.bindTooltip(newName !== "" ? newName + "%" : " ", {
                            permanent: true,
                            className: 'no-background',
                            direction: 'center',
                            offset: [0, 0] 
                        });
                    }
                    else {
                        layer.unbindTooltip();
                        layer.bindTooltip("", {
                            permanent: true,
                            className: 'no-background',
                            direction: 'center',
                            offset: [0, 0] 
                        });
                    }
                }
            });
        }
    }

    function colorBorder() {
        if (geojsonLayer) {
            geojsonLayer.setStyle(function(feature) {
                let key = feature.properties.name;
                return { 
                    color: countryColors[key],
                    weight: key === selectedCountry ? 5 : 0.5
                };
            });
        }
    }


    function selectLeaning(checkbox, leaning) {
        if (!checkbox.checked) {
            const index = selectedLeanings.indexOf(leaning);
            selectedLeanings.splice(index, 1);
        } else {
            selectedLeanings.push(leaning);
        }

        console.log(selectedLeanings);

        colorMap();
        displayGraphs();
    }

    function displayGraphs(barChart=false, leaning=null) {
        var graphContainer = document.getElementById('graph').parentNode;
        if (barChart) {
            d3.select("#surveyGraph").remove();
            var svgBarChart = d3.select(graphContainer)
                .append("div")
                .attr("id", "barChart");
    
            displayBarGraphSurvey(selectedCountry, selectedFromDate, selectedToDate, svgBarChart, leaning);
        } else {
            while (graphContainer.firstChild) {
                graphContainer.removeChild(graphContainer.firstChild);
            }
    
            d3.select(graphContainer)
            .append("div")
            .attr("class", "row chart")
            .append("h1")
            .attr("id", "countryHeader")
            .attr("class", "text-center")
            .text(selectedCountry);
    
            svg = d3.select(graphContainer)
                .append("div")
                .attr("id", "graph");
    
            graphSvg = displayGraphElection(selectedCountry, selectedFromDate, selectedToDate, svg);
    
            displayGraphSurvey(selectedCountry, selectedFromDate, selectedToDate, svg, selectedSurveyType);
        }
    }

    var leaning_mapper = {
        "Center": "center",
        "Center Left": "center-left",
        "Center Right": "center-right",
        "Far Right": "far-right",
        "Left": "left",
        "Far Left": "far-left",
        "Right": "right"
    }

    function countryColorFunc(country) {
        return ["", "white"];
    }

    function countryColorFuncCumulativeGrowth(country) {
        if (selectedToDate === undefined || selectedFromDate === undefined) {
            return "white";
        }

        var leaning_data = get_percentage_leaning_data_between(data, newCountryCodes[country], selectedFromDate, selectedToDate);
        var dates = Object.keys(leaning_data);

        first = leaning_data[dates[0]]
        last = leaning_data[dates.at(-1)]

        var aggregateFirst = 0;
        var aggregateLast = 0;

        selectedLeanings.forEach(l => {
            var leaning = l;
            var mapped_leaning = leaning_mapper[l];
           
            if (
                first != undefined && last !== undefined && 
                first[mapped_leaning] && last[mapped_leaning]
            ) {
                aggregateFirst += first[mapped_leaning];
                aggregateLast += last[mapped_leaning];
            }
        });
        var growth = (aggregateLast - aggregateFirst)
        var normalized_growth = (growth + 100) / 200;

        if (Math.round(growth) === 0) {
            return ["", "gray", ""];
        }

        return [Math.round(growth), interpolateRedGreen(normalized_growth),, ""]
    }

    function countryColorFuncLargestGrowth(country) {
        if (selectedToDate === undefined || selectedFromDate === undefined) {
            return ["", "white"];
        }

        var leaning_data = get_percentage_leaning_data_between(data, newCountryCodes[country], selectedFromDate, selectedToDate);
        var dates = Object.keys(leaning_data);

        first = leaning_data[dates[0]]
        last = leaning_data[dates.at(-1)]

        var growth = {};

        selectedLeanings.forEach(l => {
            var leaning = l;
            var mapped_leaning = leaning_mapper[l];
           
            if (
                first != undefined && last !== undefined && 
                last[mapped_leaning] !== undefined &&  first[mapped_leaning] !== undefined
            ) { 
                if (growth[mapped_leaning] === undefined) {
                    growth[mapped_leaning] = 0;
                }
                             
                growth[mapped_leaning] = last[mapped_leaning] - first[mapped_leaning];
            }
        });

        
        let largestGrowthEntry = Object.entries(growth).reduce((max, current) => {
            return (max[1] > current[1]) ? max : current;
        })[0]; 

        if (Math.round(growth[largestGrowthEntry]) === 0) {
            return ["", "gray", ""];
        }

        return [Math.round(growth[largestGrowthEntry]), leaning_colors[largestGrowthEntry], largestGrowthEntry]
    }

    function countryColorFuncLargestDecline(country) {
        if (selectedToDate === undefined || selectedFromDate === undefined) {
            return ["", "white"];
        }

        var leaning_data = get_percentage_leaning_data_between(data, newCountryCodes[country], selectedFromDate, selectedToDate);
        var dates = Object.keys(leaning_data);

        first = leaning_data[dates[0]]
        last = leaning_data[dates.at(-1)]

        var growth = {};

        selectedLeanings.forEach(l => {
            var leaning = l;
            var mapped_leaning = leaning_mapper[l];
           
            if (
                first != undefined && last !== undefined && 
                last[mapped_leaning] !== undefined &&  first[mapped_leaning] !== undefined
            ) { 
                if (growth[mapped_leaning] === undefined) {
                    growth[mapped_leaning] = 0;
                }
                             
                growth[mapped_leaning] = last[mapped_leaning] - first[mapped_leaning];
            }
        });

        
        let largestDeclinerEntry = Object.entries(growth).reduce((min, current) => {
            return (min[1] < current[1]) ? min : current;
        })[0]; 
        
        if (Math.round(growth[largestDeclinerEntry]) === 0) {
            return ["", "gray", ""];
        }

        return [Math.round(growth[largestDeclinerEntry]), leaning_colors[largestDeclinerEntry], largestDeclinerEntry]
    }

    function OnHoverCountry(countryCode) {
    }

    function OnClickCountry(countryCode) {
        selectCountry(countryCode)
        colorBorder();
    }

    function timestamp(str) {
        return new Date(str).getFullYear();
    }

    function selectCountry(country) {
        selectedCountry = country;
        document.getElementById("countryHeader").innerText = country;

        let dates = []
        dates = get_all_dates(data, newCountryCodes[country]);
        console.log(`dates outside: ${dates}`)
        selectedFromDate = dates.at(0);
        selectedToDate = dates.at(-1);
        let years = []
        years = [...new Set(dates.map(date => new Date(date).getFullYear()))];

        var slider = document.getElementById('slider');
        setupSlider(slider, dates, years)

        colorMap();
        displayGraphs();
    }
    
    function interpolateRedGreen(t) {
        if (t < 0 || t > 1) {
            return 'Value must be between 0 and 1';
        }
        const red = 255 * (1 - t);
        const green = 255 * t;
        const r = Math.round(red);
        const g = Math.round(green);
        return `rgb(${r}, ${g}, 0)`;
    }
    
    function selectMapMode(radio, type) {
        if (radio.checked) {
            selectedMapMode = type;
            
            if (selectedMapMode === "largest-growth") {
                selectedCountryColorFunc= countryColorFuncLargestGrowth;
            }
            else if (selectedMapMode === "largest-decline") {
                selectedCountryColorFunc= countryColorFuncLargestDecline; 
            }
            else if (selectedMapMode === "cumulative-growth") {
                selectedCountryColorFunc = countryColorFuncCumulativeGrowth;
            }
            colorMap();
        }
    }

    function selectSurvey(radio, type) {
        if (radio.checked) {
            selectedSurveyType = type;
            var graphContainer = document.getElementById('graph').parentNode;
            graphContainer.removeChild(graphContainer.lastChild);
            displayGraphSurvey(selectedCountry, selectedFromDate, selectedToDate, graphContainer, type);
        }
    }

</script>

</body>

</html>

<style>

</style>