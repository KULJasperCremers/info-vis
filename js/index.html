<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/nouislider/distribute/nouislider.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>
<body>

    <div id="map"></div>

    
    <div id="stuff" class="container mt-3">
        <div style="display: flex; align-items: center;">
            <h1 id="country" style="margin-right: 20px;">Country Name</h1>
            <h1 style="padding-right: 10px;">- Election year:</h1>
            <div class="dropdown" id="yearsDropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Dropdown button
                </button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                </div>
            </div>
        </div>
        
        <!-- First Row -->
        <div class="row">
            <!-- Content for Row 1, Column 1 -->
            <div class="col">
                <div id="circles"></div>
            </div>
            <div id="mostPopularLeaning" class="col">
            </div>
        </div>
    
        <!-- Second Row -->
        <div class="row">
            <div id="happiness"  class="col">
            </div>
            <div id="satisfaction" class="col">
            </div>
        </div>
    </div>

</body>

<script src="datahelper.js"></script>
<script src="map.js"></script>
<script>

    let cdata;
    d3.json("../json/ess_data_all.json").then(function(d) {
        cdata = d;
    });

    var minimized = false;
    var selectedCountry = undefined; 

    var selectedElectionYear = undefined;
    var selectedElectionYearIndex = 0;

    var cellSize = 400;

    DrawMap();

    function OnHoverCountry(countryCode) {
    }

    function OnClickCountry(countryCode) {
        console.log("click: " + countryCode);
        
        selectedCountry = countryCode;

        document.getElementById("country").innerText=countryCode;
        if (!minimized) {
            SwitchMap();
        }
        else {
            OnMinimized();
        }
    }

    function SwitchMap() {
        minimized = !minimized;
        DrawMap();
    }

    function DrawMap() {
        d3.select('#map').selectAll('*').remove();

        if (!minimized) {

            var w = window.innerWidth * 0.9;
            var h = w / 2;

            var svg = AppendMap('#map', OnHoverCountry, OnClickCountry, w, h);
            d3.select('#map').classed('minimized', false);
            d3.select('#map').classed('maximized', true);

            document.getElementById('stuff').classList.add('hidden');

            OnMaximized();

        } else {
            var svg = AppendMap('#map', OnHoverCountry, OnClickCountry, 500, 300);
            d3.select('#map').classed('minimized', true);
            d3.select('#map').classed('maximized', false);

            svg.append("image")
                .attr("xlink:href", "https://cdn.icon-icons.com/icons2/390/PNG/512/expand_38551.png") // Ensure the use of xlink:href for compatibility
                .attr("x", 10)
                .attr("y", 10)
                .attr("width", 30)
                .attr("height", 30)
                .on("click", function() {
                    SwitchMap();
                });

            document.getElementById('stuff').classList.remove('hidden');
            
            OnMinimized();
        }

    }

    window.addEventListener('resize', function(event) {
        DrawMap();
    }, true);
  
    function OnMinimized() {

        // Fill dropdown
        var years = getElectionYears(cdata, countryCodes[selectedCountry]);
        selectedElectionYear = years[years.length - 1];
        selectedElectionYearIndex = years.length - years.indexOf(selectedElectionYear) - 1;

        OnReloadMinimized();
        
    }

    function OnReloadMinimized() {


        // Fill dropdown
        var years = getElectionYears(cdata, countryCodes[selectedCountry]);

        selectedElectionYearIndex = years.length - years.indexOf(selectedElectionYear) - 1;

        console.log(selectedElectionYearIndex)

        d3.select("#yearsDropdown .dropdown-menu").selectAll('*').remove();

        $(years).each(function(index, year) {
            $('#yearsDropdown .dropdown-menu').append(
                `<a class="dropdown-item" href="#">${year}</a>`
            );
        });
        $('#dropdownMenuButton').text(selectedElectionYear);

        $('#yearsDropdown .dropdown-item').click(function() {
            selectedElectionYear = $(this).text();
            OnReloadMinimized(); // Change button text to the clicked item
        });

        // Circles
        // First, select the div where you want to append the SVG
        const div1 = d3.select("#circles");
        
        // Clear previous SVG if exists
        div1.selectAll("svg").remove();
        
        const svg1 = div1.append("svg")
        .attr("width", cellSize) 
        .attr("height", cellSize)

        const flattenedCircles = getPercentageCircles(cdata, countryCodes[selectedCountry], selectedElectionYearIndex, 1000, 1000)

        // Draw circles
        svg1.selectAll("circle")
            .data(flattenedCircles)
            .enter().append("circle")
            .attr("cx", d => d.cx / 2)
            .attr("cy", d => d.cy / 2)
            .attr("r", d => d.radius)
            .style("fill", (d, i) => d.color);
     
        // Barchart Leaning
        // First, select the div where you want to append the SVG
        const div2 = d3.select("#mostPopularLeaning");
        div2.selectAll("svg").remove();

        const leaningData = getLeaningDataAtIndex(cdata, countryCodes[selectedCountry], selectedElectionYearIndex);
        var data = Object.keys(leaningData).map(function(key) {
            return { party: key, value: leaningData[key] };
        });

        console.log(data)

        var svgWidth = cellSize, svgHeight = cellSize;
        var margin = { top: 20, right: 20, bottom: 70, left: 50 };
        var width = svgWidth - margin.left - margin.right;
        var height = svgHeight - margin.top - margin.bottom;

        var svg2 = d3.select('#mostPopularLeaning')
        .append('svg')
        .attr('width', svgWidth)
        .attr('height', svgHeight)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        var x = d3.scaleBand().range([0, width]).padding(0.1),
        y = d3.scaleLinear().range([height, 0]);

        x.domain(data.map(function(d) { return d.party; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        svg2.append('g')
        .attr('transform', 'translate(0,' + height + ')')
        .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");

        svg2.append('g')
        .call(d3.axisLeft(y));

        // Draw the bars
        svg2.selectAll('.bar')
        .data(data)
        .enter().append('rect')
        .attr('class', 'bar')
        .attr('x', function(d) { return x(d.party); })
        .attr('y', function(d) { return y(d.value); })
        .attr('width', x.bandwidth())
        .attr('height', function(d) { return height - y(d.value); })
        .attr('fill', 'steelblue');

        svg2.append("text")
        .attr("class", "title")
        .attr("x", width / 2)
        .attr("y", 5) 
        .attr("text-anchor", "middle")
        .style("font-size", "1.5rem") 
        .text("Leanings");

        // Happiness
        var countries = Object.keys(cdata);
        var years = mapYears(cdata,countries);
        var aggregatedsurveyData = aggregateSurveyData(cdata,years);
        // console.log(aggregatedsurveyData);
        var hapinessData = querySurveyDataCountryYearColumn(aggregatedsurveyData,years,countryCodes[selectedCountry],selectedElectionYearIndex,"happy")["sum"];

        // First, select the div where you want to append the SVG
        const div3 = d3.select("#happiness");
        div3.selectAll("svg").remove();

        var data = Object.keys(hapinessData).map(function(key) {
            return { party: key, value: hapinessData[key] };
        });

        var svgWidth = cellSize, svgHeight = cellSize;
        var margin = { top: 20, right: 20, bottom: 70, left: 50 };
        var width = svgWidth - margin.left - margin.right;
        var height = svgHeight - margin.top - margin.bottom;

        var svg3 = d3.select('#happiness')
        .append('svg')
        .attr('width', svgWidth)
        .attr('height', svgHeight)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        var x = d3.scaleBand().range([0, width]).padding(0.1),
        y = d3.scaleLinear().range([height, 0]);

        x.domain(data.map(function(d) { return d.party; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        svg3.append('g')
        .attr('transform', 'translate(0,' + height + ')')
        .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");

        svg3.append('g')
        .call(d3.axisLeft(y));

        // Draw the bars
        svg3.selectAll('.bar')
        .data(data)
        .enter().append('rect')
        .attr('class', 'bar')
        .attr('x', function(d) { return x(d.party); })
        .attr('y', function(d) { return y(d.value); })
        .attr('width', x.bandwidth())
        .attr('height', function(d) { return height - y(d.value); })
        .attr('fill', 'steelblue');

        svg3.append("text")
        .attr("class", "title")
        .attr("x", width / 2)
        .attr("y", 5) 
        .attr("text-anchor", "middle")
        .style("font-size", "1.5rem")  
        .text("Hapiness");

         // Satisfaction
        var countries = Object.keys(cdata);
        var years = mapYears(cdata,countries);
        var aggregatedsurveyData = aggregateSurveyData(cdata,years);
        // console.log(aggregatedsurveyData);
        var hapinessData = querySurveyDataCountryYearColumn(aggregatedsurveyData,years,countryCodes[selectedCountry],selectedElectionYearIndex,"satisfaction")["sum"];

        // First, select the div where you want to append the SVG
        const div4 = d3.select("#satisfaction");
        div4.selectAll("svg").remove();

        var data = Object.keys(hapinessData).map(function(key) {
            return { party: key, value: hapinessData[key] };
        });

        var svgWidth = cellSize, svgHeight = cellSize;
        var margin = { top: 20, right: 20, bottom: 70, left: 50 };
        var width = svgWidth - margin.left - margin.right;
        var height = svgHeight - margin.top - margin.bottom;

        var svg4 = d3.select('#satisfaction')
        .append('svg')
        .attr('width', svgWidth)
        .attr('height', svgHeight)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        var x = d3.scaleBand().range([0, width]).padding(0.1),
        y = d3.scaleLinear().range([height, 0]);

        x.domain(data.map(function(d) { return d.party; }));
        y.domain([0, d3.max(data, function(d) { return d.value; })]);

        svg4.append('g')
        .attr('transform', 'translate(0,' + height + ')')
        .call(d3.axisBottom(x))
        .selectAll("text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr("transform", "rotate(-65)");

        svg4.append('g')
        .call(d3.axisLeft(y));

        // Draw the bars
        svg4.selectAll('.bar')
        .data(data)
        .enter().append('rect')
        .attr('class', 'bar')
        .attr('x', function(d) { return x(d.party); })
        .attr('y', function(d) { return y(d.value); })
        .attr('width', x.bandwidth())
        .attr('height', function(d) { return height - y(d.value); })
        .attr('fill', 'steelblue');

        svg4.append("text")
        .attr("class", "title")
        .attr("x", width / 2)
        .attr("y", 5) 
        .attr("text-anchor", "middle")
        .style("font-size", "1.5rem") 
        .text("Satisfaction");

    }

    function OnMaximized() {

    }

</script>

</html>

<style>
    
    .minimized {
        position: fixed;
        bottom: 10px;
        right: 10px;
        border-style: groove;
        z-index: 1000; /* Ensure it sits on top of other content */
    }

    .maximized {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh; /* Example height - adjust as needed */
    }

    .hidden {
        display: none;
    }

    .flex-container {
        display: flex;
        align-items: center;
    }

    .flex-container h1 {
        margin-right: 20px; 
    }

</style>