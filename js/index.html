<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
        <div class="row">
            <div class="col chart" style="margin-right: -37;">
                <h1 class="text-center" id="countryHeader">Country</h1>
                <div id="graph"></div>
            </div>
            <div class="col-1 chart" style="margin-right: -50;">
                <div  style="margin-top: 200%;">
                    <p><strong>Leanings</strong></p>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-far-left" style="background-color:red;" onclick="selectLeaning('Far Left')">
                        <label class="form-check-label" for="radio-far-left">
                        <strong>Far left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-left" style="background-color: aquamarine;" onclick="selectLeaning('Left')">
                        <label class="form-check-label" for="radio-left">
                            <strong>Left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-center-left" style="background-color: rgb(83, 153, 95);" onclick="selectLeaning('Center Left')">
                        <label class="form-check-label" for="radio-center-left">
                            <strong>Center Left</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-center" style="background-color: blueviolet;" onclick="selectLeaning('Center')">
                        <label class="form-check-label" for="radio-center">
                            <strong>Center</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-center-right" style="background-color:burlywood ;" onclick="selectLeaning('Center Right')">
                        <label class="form-check-label" for="radio-center-right">
                            <strong>Center Right</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-right" style="background-color:coral;" onclick="selectLeaning('Right')">
                        <label class="form-check-label" for="radio-right">
                            <strong>Right</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="radio-far-right" checked style="background-color:blue;" onclick="selectLeaning('Far Right')">
                        <label class="form-check-label" for="radio-far-right">
                            <strong>Far Right</strong>
                        </label>
                    </div>
                </div>
            </div>
            <div class="col">
            <div class="row chart">
                <h1 class="text-center">Map filters</h1>
                <div class="row">
                    <div class="col">
                        <p>From (Date)</p>
                        <div class="dropdown" id="dropdownFrom" style="margin: 1rem;">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownFromButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Dropdown button
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonBigMap">
                            </div>
                        </div>
                    </div>
    
                    <div class="col">
                        <p>To (Date)</p>
                        <div class="dropdown" id="dropdownTo" style="margin: 1rem;">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownToButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Dropdown button
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButtonBigMap">
                                    
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="row chart">
                <div class="col chart" style="position: relative;">
                    
                    <div id="map"></div>
                </div>
            </div>
            </div>
        </div>

<script src="datahelper.js"></script>
<script src="map.js"></script>
<script>

    let cdata;
    let aggregatedsurveyData;
    let years;
    let countries;
    d3.json("../json/ess_data_all.json").then(function(d) {
        cdata = d;
        countries = Object.keys(cdata);
        years = mapYears(cdata,countries);
        aggregatedsurveyData = aggregateSurveyData(cdata,years);

        graph(cdata, "Belgium", 2003, 2019);
    });
    
    var cellSize = 400;
    var selectedCountry = undefined; 
    var selectedLeaning = "Far Right"

    var selectedFromDate = undefined;
    var selectedToDate = undefined;


    
    function selectLeaning(leaning) {
        selectedLeaning = leaning
        drawMap(countryColorFuncGrowth);
        console.log("click: " + leaning);
    }

    var leaning_mapper = {
        "Center": "center",
        "Center Left": "center-left",
        "Center Right": "center-right",
        "Far Right": "far-right",
        "Left": "left",
        "Far Left": "far-left",
        "Right": "right"
    }

    function countryColorFunc(country) {
        return "white";
    }


    function countryColorFuncGrowth(country) {
        // anbs growth
        console.log(country + " from: " + selectedFromDate + ", to: " + selectedToDate)

        if (selectedToDate === undefined || selectedFromDate === undefined) {
            return "white";
        }

        let data = aggregateDashboardDataForCountryBetweenYears(cdata, country, selectedFromDate, selectedToDate)["percentagesLeaning"];
        
        leaning = leaning_mapper[selectedLeaning]
        if (country === "Germany") {
                console.log(data)
            }

        first = data[Object.keys(data)[0]]
        last = data[Object.keys(data).at(-1)]

        if (first[leaning] && last[leaning]) {
            var growth = ((last[leaning] - first[leaning]) + 100) / 200;
            if (country === "Germany") {
                console.log(data[Object.keys(data)[0]][leaning])
                console.log(data[Object.keys(data).at(-1)][leaning])
                console.log(data)
                console.log(growth)
            }
            return interpolateRedGreen(growth)
        }
        else {
            return "white";
        }
    }

    function OnHoverCountry(countryCode) {
    }

    function OnClickCountry(countryCode) {
        console.log("click: " + countryCode);
        selectCountry(countryCode)
    }

    function drawMap(colorFunc) {
        d3.select('#map').selectAll('*').remove();
        var mapContainer = document.getElementById('map').parentNode;
        var w = mapContainer.clientWidth;
        var h = w * 1;  
        var svg = AppendMap('#map', OnHoverCountry, OnClickCountry, colorFunc, w, h);
    }

    function selectCountry(country) {
        selectedCountry = country;
        document.getElementById("countryHeader").innerText= country;

        var countryData = cdata[newCountryCodes[country]];
        var allElectionYears = Object.keys(countryData[dataTypes.election]).map(Number)

        selectedFromDate = allElectionYears[0]

        fillFromDatesDropdown("dropdownFrom", allElectionYears, 0, 
            function(text) {
                selectedFromDate = text;
            }
        );
        fillToDatesDropdown("dropdownTo", allElectionYears, 0);
    }

    function fillFromDatesDropdown(id, dates, selectIndex) {
        var $dropdown = $('#' + id);
        var $dropdownMenu = $dropdown.find('.dropdown-menu');
        var $dropdownButton = $dropdown.find('button.dropdown-toggle, a.dropdown-toggle');

        $dropdownMenu.empty();

        $.each(dates, function(index, year) {
            $dropdownMenu.append(`<a class="dropdown-item" href="#" data-year="${year}">${year}</a>`);
        });

        $dropdownButton.text(dates[selectIndex]);

        $dropdownMenu.on('click', '.dropdown-item', function(e) {
            var selectedText = $(this).text();
            $dropdownButton.text(selectedText); 
            selectedFromDate = selectedText;

            drawMap(countryColorFuncGrowth);
        });
    }

    function fillToDatesDropdown(id, dates, selectIndex) {
        var $dropdown = $('#' + id);
        var $dropdownMenu = $dropdown.find('.dropdown-menu');
        var $dropdownButton = $dropdown.find('button.dropdown-toggle, a.dropdown-toggle');

        $dropdownMenu.empty();

        $.each(dates, function(index, year) {
            $dropdownMenu.append(`<a class="dropdown-item" href="#" data-year="${year}">${year}</a>`);
        });

        $dropdownButton.text(dates[selectIndex]);

        $dropdownMenu.on('click', '.dropdown-item', function(e) {
            var selectedText = $(this).text();
            $dropdownButton.text(selectedText);
            selectedToDate = selectedText;

            drawMap(countryColorFuncGrowth);
        });
    }

    drawMap(countryColorFunc);

    function graph() {
        let growthData = aggregateDashboardDataForCountryBetweenYears(cdata, "Belgium", 2003, 2019);
        let years = Object.keys(growthData.electionGrowth).map(Number);
        let politicalLeanings = ["far-left", "left", "center-left", "center", "center-right", "right", "far-right"];

        console.log(growthData)

        // Get the graphContainer
        var graphContainer = document.getElementById('graph').parentNode;

        // Get the width and height of the graphContainer
        var width = graphContainer.clientWidth;
        var height = graphContainer.clientHeight;

        // Create an SVG in the graphContainer
        var svg = d3.select(graphContainer)
        .append("svg")
            .attr("width", width - 25)
            .attr("height", height / 2);

        // Define the scales
        let xScale = d3.scaleBand().domain(years).range([0, width]);
        let colorScale = d3.scaleOrdinal().domain(politicalLeanings).range(colors);
        let yScaleLeft = d3.scaleLinear().domain([-1, 1]).range([height, 0]);
        let yScaleRight = d3.scaleLinear().domain([-50, 160]).range([height, 0]);

        // Define the line generator
        let line = d3.line()
            .x((d) => xScale(d.year))
            .y((d) => yScaleLeft(d.absoluteGrowth));

            console.log(graphContainer.clientWidth, graphContainer.clientHeight);

        // Loop over the years
        for (let year of years) {
            // Loop over the political leanings
            for (let leaning of politicalLeanings) {
                // Get the growth data for this year and leaning
                let growth = growthData.electionGrowth[year][leaning];

                // Check if growth is defined
                if (growth) {
                    // Generate a line for the absolute growth
                    svg.append("path")
                        .datum(growth)
                        .attr("fill", "none")
                        .attr("stroke", colorScale(leaning))
                        .attr("d", line);

                    // Generate a bar for the relative growth
                    svg.append("rect")
                        .attr("class", "bar")
                        .attr("x", xScale(year))
                        .attr("y", yScaleRight(growth.relativeGrowth))
                        .attr("width", xScale.bandwidth())
                        .attr("height", height - yScaleRight(growth.relativeGrowth))
                        .attr("fill", colorScale(leaning));
                }
            }
        }

        // Add axes and labels
        svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(xScale));

        svg.append("g")
            .call(d3.axisLeft(yScaleLeft));

        svg.append("g")
            .attr("transform", "translate(" + width + ",0)")
            .call(d3.axisRight(yScaleRight));

                
    }

    function interpolateRedGreen(t) {
        if (t < 0 || t > 1) {
            return 'Value must be between 0 and 1';
        }

        // Calculate red and green components
        const red = 255 * (1 - t);
        const green = 255 * t;

        // Convert each component to an integer
        const r = Math.round(red);
        const g = Math.round(green);

        // Return the color in hexadecimal format
        return `rgb(${r}, ${g}, 0)`;
    }

</script>

</body>

</html>
